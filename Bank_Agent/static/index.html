<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Banking Analytics AI Team</title>

  <!-- Bootstrap 5.3 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Font Awesome 6 -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet" />
  <!-- highlight.js (dark) for code blocks inside markdown -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" rel="stylesheet" />
  <!-- marked.js â€“ markdown renderer -->
  <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
  <!-- highlight.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <style>
    /* â”€â”€ Root palette â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    :root {
      --bg-base    : #0d1117;
      --bg-card    : #161b22;
      --bg-sidebar : #111318;
      --bg-console : #0d1117;
      --border     : #30363d;
      --primary    : #2f81f7;
      --primary-dim: #1a4f9f;
      --success    : #3fb950;
      --warning    : #d29922;
      --danger     : #f85149;
      --text       : #e6edf3;
      --text-muted : #8b949e;
      --badge-bg   : #21262d;
    }

    /* â”€â”€ Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    html, body { height: 100%; background: var(--bg-base); color: var(--text); font-family: 'Segoe UI', sans-serif; }
    a { color: var(--primary); }

    /* â”€â”€ Navbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .navbar-custom {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      padding: .6rem 1.5rem;
    }
    .navbar-brand-icon { font-size: 1.6rem; margin-right: .5rem; }
    .brand-title { font-size: 1.15rem; font-weight: 700; letter-spacing: .3px; }
    .brand-sub   { font-size: .72rem; color: var(--text-muted); }

    /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .main-layout { display: flex; height: calc(100vh - 57px); overflow: hidden; }

    /* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .sidebar {
      width: 300px; min-width: 280px;
      background: var(--bg-sidebar);
      border-right: 1px solid var(--border);
      overflow-y: auto; padding: 1.2rem 1rem;
      display: flex; flex-direction: column; gap: .9rem;
    }
    .sidebar-section { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: .9rem 1rem; }
    .sidebar-section h6 { font-size: .78rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: .6px; margin-bottom: .7rem; }

    /* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn-run {
      background: var(--primary); border: none; color: #fff;
      font-weight: 600; padding: .55rem 1.2rem; border-radius: 7px;
      width: 100%; transition: background .15s;
    }
    .btn-run:hover:not(:disabled) { background: #4893fa; }
    .btn-run:disabled { opacity: .5; cursor: not-allowed; }
    .btn-stop { background: var(--danger); }
    .btn-stop:hover:not(:disabled) { background: #ff6b61; }

    /* â”€â”€ Status pill â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .status-pill {
      display: inline-flex; align-items: center; gap: .4rem;
      font-size: .78rem; font-weight: 600; padding: .25rem .75rem;
      border-radius: 20px;
    }
    .status-idle      { background: var(--badge-bg); color: var(--text-muted); }
    .status-running   { background: #1a3a5c; color: #60b4ff; }
    .status-completed { background: #0d2e1a; color: var(--success); }
    .status-error     { background: #2e1a1a; color: var(--danger); }
    .pulse { width: 8px; height: 8px; border-radius: 50%; animation: pulse 1.2s infinite; }
    .pulse-blue  { background: #60b4ff; }
    .pulse-green { background: var(--success); }
    .pulse-red   { background: var(--danger); }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.3} }

    /* â”€â”€ Content area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .content-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

    /* â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tab-bar {
      background: var(--bg-card); border-bottom: 1px solid var(--border);
      padding: 0 1.2rem; display: flex; align-items: center; gap: 0;
      flex-shrink: 0;
    }
    .tab-btn {
      background: none; border: none; border-bottom: 2px solid transparent;
      color: var(--text-muted); padding: .7rem 1rem; font-size: .88rem; font-weight: 500;
      cursor: pointer; transition: all .15s; white-space: nowrap;
    }
    .tab-btn:hover { color: var(--text); }
    .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
    .tab-pane { display: none; flex: 1; overflow: hidden; }
    .tab-pane.active { display: flex; flex-direction: column; }

    /* â”€â”€ Console â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .console-wrap { flex: 1; overflow: hidden; display: flex; flex-direction: column; padding: 0; }
    #console-output {
      flex: 1; overflow-y: auto; background: var(--bg-console);
      font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
      font-size: .8rem; line-height: 1.55; padding: 1rem 1.2rem; margin: 0;
      color: #c9d1d9;
    }
    .log-info    { color: #8b949e; }
    .log-log     { color: #c9d1d9; }
    .log-success { color: #3fb950; }
    .log-error   { color: #f85149; }
    .log-warn    { color: #d29922; }
    .log-agent   { color: #79c0ff; }
    .console-empty { color: var(--text-muted); font-size: .85rem; text-align: center; margin-top: 3rem; }

    /* â”€â”€ Markdown report â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .report-wrap { flex: 1; overflow-y: auto; padding: 1.8rem 2.2rem; background: var(--bg-base); }
    .report-placeholder { color: var(--text-muted); text-align: center; margin-top: 5rem; }
    .md-body { max-width: 900px; margin: 0 auto; }
    .md-body h1 { font-size: 1.7rem; font-weight: 700; color: #79c0ff; border-bottom: 1px solid var(--border); padding-bottom: .5rem; margin-bottom: 1.2rem; }
    .md-body h2 { font-size: 1.25rem; font-weight: 700; color: #d2a8ff; margin-top: 1.8rem; margin-bottom: .7rem; }
    .md-body h3 { font-size: 1.05rem; font-weight: 600; color: #ffa657; margin-top: 1.4rem; }
    .md-body h4 { font-size: .95rem; font-weight: 600; color: #e6edf3; }
    .md-body p  { line-height: 1.75; color: #c9d1d9; margin-bottom: .85rem; }
    .md-body ul, .md-body ol { padding-left: 1.4rem; margin-bottom: .85rem; }
    .md-body li { line-height: 1.7; color: #c9d1d9; margin-bottom: .2rem; }
    .md-body strong { color: #e6edf3; font-weight: 700; }
    .md-body em     { color: #d2a8ff; }
    .md-body blockquote {
      border-left: 3px solid var(--primary); margin: 1rem 0; padding: .6rem 1rem;
      background: var(--bg-card); border-radius: 0 6px 6px 0; color: var(--text-muted);
    }
    .md-body table { width: 100%; border-collapse: collapse; margin: 1rem 0; font-size: .88rem; }
    .md-body th { background: var(--bg-card); color: #79c0ff; padding: .55rem .9rem; border: 1px solid var(--border); text-align: left; }
    .md-body td { padding: .5rem .9rem; border: 1px solid var(--border); color: #c9d1d9; }
    .md-body tr:nth-child(even) td { background: #161b2244; }
    .md-body code {
      background: var(--bg-card); color: #79c0ff; padding: .1rem .4rem;
      border-radius: 4px; font-size: .85em; font-family: 'Cascadia Code', 'Fira Code', monospace;
    }
    .md-body pre {
      background: var(--bg-console); border: 1px solid var(--border); border-radius: 8px;
      padding: 1rem; overflow-x: auto; margin: 1rem 0;
    }
    .md-body pre code { background: none; padding: 0; color: inherit; }
    .md-body hr { border-color: var(--border); margin: 1.5rem 0; }

    /* â”€â”€ Charts gallery â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .charts-wrap { flex: 1; overflow-y: auto; padding: 1.2rem 1.4rem; background: var(--bg-base); }
    .chart-card {
      background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px;
      overflow: hidden; cursor: pointer; transition: transform .15s, border-color .15s;
    }
    .chart-card:hover { transform: translateY(-2px); border-color: var(--primary); }
    .chart-card img { width: 100%; height: 200px; object-fit: cover; display: block; }
    .chart-card .chart-name {
      padding: .5rem .75rem; font-size: .78rem; color: var(--text-muted);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      border-top: 1px solid var(--border);
    }
    .charts-placeholder { color: var(--text-muted); text-align: center; margin-top: 5rem; }

    /* â”€â”€ Downloads â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .downloads-wrap { flex: 1; overflow-y: auto; padding: 1.4rem 1.8rem; background: var(--bg-base); }
    .file-item {
      display: flex; align-items: center; gap: .9rem;
      background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px;
      padding: .75rem 1rem; margin-bottom: .6rem; transition: border-color .15s;
    }
    .file-item:hover { border-color: var(--primary); }
    .file-icon { font-size: 1.6rem; width: 36px; text-align: center; }
    .file-info { flex: 1; min-width: 0; }
    .file-name { font-size: .9rem; font-weight: 600; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .file-meta { font-size: .75rem; color: var(--text-muted); }
    .icon-pdf  { color: #f85149; }
    .icon-pptx { color: #d29922; }
    .icon-md   { color: #3fb950; }
    .icon-png  { color: var(--primary); }

    /* â”€â”€ Lightbox â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #lightbox {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,.88);
      z-index: 9999; align-items: center; justify-content: center;
    }
    #lightbox.open { display: flex; }
    #lightbox img { max-width: 92vw; max-height: 88vh; border-radius: 8px; box-shadow: 0 0 40px #000; }
    #lightbox-close {
      position: absolute; top: 1rem; right: 1.4rem; font-size: 1.8rem;
      color: #fff; cursor: pointer; opacity: .8;
    }
    #lightbox-close:hover { opacity: 1; }

    /* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #toast-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 9000; }
    .toast-msg {
      background: var(--bg-card); border: 1px solid var(--border);
      color: var(--text); padding: .75rem 1.2rem; border-radius: 8px; margin-top: .5rem;
      font-size: .88rem; min-width: 280px; animation: slideIn .3s ease;
      display: flex; align-items: center; gap: .6rem;
    }
    @keyframes slideIn { from{transform:translateX(50px);opacity:0} to{transform:translateX(0);opacity:1} }

    /* â”€â”€ Textarea & form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    textarea.form-control, .form-control, .form-select {
      background: var(--bg-base); border-color: var(--border); color: var(--text); font-size: .84rem;
    }
    textarea.form-control:focus, .form-control:focus {
      background: var(--bg-base); border-color: var(--primary); box-shadow: 0 0 0 .2rem #2f81f730; color: var(--text);
    }
    .form-check-input:checked { background-color: var(--primary); border-color: var(--primary); }

    /* â”€â”€ Scrollbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #484f58; }

    /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 768px) {
      .main-layout { flex-direction: column; }
      .sidebar { width: 100%; min-width: unset; border-right: none; border-bottom: 1px solid var(--border); max-height: 340px; }
    }
  </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• NAVBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<nav class="navbar navbar-custom d-flex align-items-center justify-content-between">
  <div class="d-flex align-items-center">
    <span class="navbar-brand-icon">ğŸ¦</span>
    <div>
      <div class="brand-title">Banking Analytics AI Team</div>
      <div class="brand-sub">Manager Â· Data Engineer Â· Data Scientist Â· Data Analyst</div>
    </div>
  </div>
  <div class="d-flex align-items-center gap-3">
    <span id="global-status" class="status-pill status-idle">
      <span class="pulse pulse-blue" style="display:none" id="pulse-dot"></span>
      <i class="fa fa-circle-dot me-1" id="status-icon"></i>
      <span id="status-text">Idle</span>
    </span>
    <span class="text-muted" style="font-size:.78rem">
      <i class="fa-brands fa-python me-1"></i>FastAPI + CrewAI + LangGraph
    </span>
  </div>
</nav>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN LAYOUT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="main-layout">

  <!-- â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <aside class="sidebar">

    <!-- Analysis request -->
    <div class="sidebar-section" style="flex:1">
      <h6><i class="fa fa-file-lines me-1"></i>Analysis Request</h6>
      <textarea id="analysis-request" class="form-control"
                rows="8" style="resize:vertical"
                placeholder="Leave blank to use the default comprehensive banking analysis..."></textarea>
      <div class="text-muted mt-1" style="font-size:.72rem">
        Leave blank for the default full-stack analysis.
      </div>
    </div>

    <!-- Options -->
    <div class="sidebar-section">
      <h6><i class="fa fa-sliders me-1"></i>Options</h6>
      <div class="form-check form-switch mb-2">
        <input class="form-check-input" type="checkbox" id="use-langgraph" checked />
        <label class="form-check-label" for="use-langgraph" style="font-size:.84rem">
          LangGraph strategic planning
        </label>
      </div>
    </div>

    <!-- Action buttons -->
    <div>
      <button id="btn-run" class="btn-run btn mb-2" onclick="startAnalysis()">
        <i class="fa fa-play me-2"></i>Start Analysis
      </button>
      <button id="btn-clear" class="btn w-100" style="background:var(--badge-bg);border:1px solid var(--border);color:var(--text-muted);font-size:.84rem"
              onclick="clearConsole()">
        <i class="fa fa-trash me-1"></i>Clear Console
      </button>
    </div>

    <!-- Agent legend -->
    <div class="sidebar-section" style="font-size:.78rem;color:var(--text-muted)">
      <h6><i class="fa fa-robot me-1"></i>Agent Team</h6>
      <div class="d-flex flex-column gap-1">
        <span><i class="fa fa-crown me-2" style="color:#d29922"></i>Manager (CDO)</span>
        <span><i class="fa fa-database me-2" style="color:#60b4ff"></i>Data Engineer</span>
        <span><i class="fa fa-brain me-2" style="color:#d2a8ff"></i>Data Scientist</span>
        <span><i class="fa fa-chart-pie me-2" style="color:#3fb950"></i>Data Analyst</span>
      </div>
    </div>

  </aside>

  <!-- â”€â”€ CONTENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="content-area">

    <!-- Tab bar -->
    <div class="tab-bar">
      <button class="tab-btn active" onclick="switchTab('console',this)">
        <i class="fa fa-terminal me-1"></i>Console
      </button>
      <button class="tab-btn" onclick="switchTab('report',this)">
        <i class="fa fa-file-lines me-1"></i>Report
        <span id="tab-report-badge" class="badge rounded-pill ms-1" style="background:#2f81f7;display:none">New</span>
      </button>
      <button class="tab-btn" onclick="switchTab('charts',this)">
        <i class="fa fa-chart-bar me-1"></i>Charts
        <span id="tab-charts-badge" class="badge rounded-pill ms-1" style="background:#3fb950;display:none">0</span>
      </button>
      <button class="tab-btn" onclick="switchTab('downloads',this)">
        <i class="fa fa-download me-1"></i>Downloads
        <span id="tab-dl-badge" class="badge rounded-pill ms-1" style="background:#d29922;display:none">0</span>
      </button>
    </div>

    <!-- â”€â”€ CONSOLE tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="tab-console" class="tab-pane active">
      <div class="console-wrap">
        <pre id="console-output"><span class="console-empty">
  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  â•‘      Banking Analytics Multi-Agent System           â•‘
  â•‘  Configure banks on the left, then press Start.     â•‘
  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
</span></pre>
      </div>
    </div>

    <!-- â”€â”€ REPORT tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="tab-report" class="tab-pane">
      <div class="report-wrap">
        <div id="report-placeholder" class="report-placeholder">
          <i class="fa fa-file-lines fa-3x mb-3" style="color:var(--border)"></i>
          <p>The analysis report will appear here once the run completes.</p>
        </div>
        <div id="md-body" class="md-body" style="display:none"></div>
      </div>
    </div>

    <!-- â”€â”€ CHARTS tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="tab-charts" class="tab-pane">
      <div class="charts-wrap">
        <div id="charts-placeholder" class="charts-placeholder">
          <i class="fa fa-chart-bar fa-3x mb-3" style="color:var(--border)"></i>
          <p>Charts will appear here after analysis completes.</p>
        </div>
        <div id="charts-grid" class="row g-3" style="display:none"></div>
      </div>
    </div>

    <!-- â”€â”€ DOWNLOADS tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="tab-downloads" class="tab-pane">
      <div class="downloads-wrap">
        <div id="downloads-placeholder" class="charts-placeholder">
          <i class="fa fa-download fa-3x mb-3" style="color:var(--border)"></i>
          <p>PDF, PowerPoint, and Markdown reports will appear here.</p>
        </div>
        <div id="downloads-list" style="display:none"></div>
      </div>
    </div>

  </div><!-- /content-area -->
</div><!-- /main-layout -->

<!-- â”€â”€ Lightbox â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="lightbox">
  <span id="lightbox-close" onclick="closeLightbox()"><i class="fa fa-xmark"></i></span>
  <img id="lightbox-img" src="" alt="Chart" />
</div>

<!-- â”€â”€ Toast container â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="toast-container"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCRIPTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   State
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let currentTaskId   = null;
let sseSource       = null;
let isRunning       = false;
let autoScrollConsole = true;

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   marked.js config
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
marked.setOptions({
  highlight: (code, lang) => {
    if (lang && hljs.getLanguage(lang)) {
      return hljs.highlight(code, { language: lang }).value;
    }
    return hljs.highlightAuto(code).value;
  },
  breaks: true,
  gfm:    true,
});

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Tab switching
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function switchTab(name, btn) {
  document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(`tab-${name}`).classList.add('active');
  btn.classList.add('active');
  if (name === 'charts' && currentTaskId) refreshCharts();
  if (name === 'downloads' && currentTaskId) refreshDownloads();
}


/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Console helpers
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const consoleEl = document.getElementById('console-output');

function appendLog(entry) {
  // Remove the placeholder on first message
  const placeholder = consoleEl.querySelector('.console-empty');
  if (placeholder) placeholder.remove();

  const line = document.createElement('span');
  const type = (entry.type || 'log').toLowerCase();

  // Colour-code by type + by crew/agent keywords in message
  let cls = 'log-log';
  if (type === 'info')    cls = 'log-info';
  if (type === 'success') cls = 'log-success';
  if (type === 'error')   cls = 'log-error';
  if (type === 'warn')    cls = 'log-warn';

  const msg = entry.message || '';
  if (/agent|task|crew|working on|delegating|executing/i.test(msg)) cls = 'log-agent';

  const ts = entry.timestamp ? new Date(entry.timestamp).toLocaleTimeString() : '';
  line.className = cls;
  line.textContent = ts ? `[${ts}] ${msg}\n` : `${msg}\n`;
  consoleEl.appendChild(line);

  if (autoScrollConsole) consoleEl.scrollTop = consoleEl.scrollHeight;
}

function clearConsole() {
  consoleEl.innerHTML = '<span class="console-empty">Console cleared. Start a new analysis to see output.</span>';
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Status bar
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function setStatus(state) {
  const pill = document.getElementById('global-status');
  const icon = document.getElementById('status-icon');
  const text = document.getElementById('status-text');
  const dot  = document.getElementById('pulse-dot');

  pill.className = `status-pill status-${state}`;
  dot.style.display  = state === 'running' ? 'block' : 'none';

  const map = {
    idle:      ['fa-circle-dot', 'Idle'],
    running:   ['fa-spinner fa-spin', 'Runningâ€¦'],
    completed: ['fa-circle-check', 'Completed'],
    error:     ['fa-circle-xmark', 'Error'],
  };
  const [ico, label] = map[state] || map.idle;
  icon.className = `fa ${ico} me-1`;
  text.textContent = label;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Toast notifications
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function toast(msg, type = 'info') {
  const icons = { info: 'ğŸ’¬', success: 'âœ…', error: 'âŒ', warn: 'âš ï¸' };
  const container = document.getElementById('toast-container');
  const el = document.createElement('div');
  el.className = 'toast-msg';
  el.innerHTML = `<span>${icons[type] || 'ğŸ’¬'}</span><span>${msg}</span>`;
  container.appendChild(el);
  setTimeout(() => el.remove(), 4500);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Start analysis
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function startAnalysis() {
  if (isRunning) { toast('Analysis already running.', 'warn'); return; }

  // Reset UI
  clearConsole();
  document.getElementById('md-body').innerHTML = '';
  document.getElementById('md-body').style.display = 'none';
  document.getElementById('report-placeholder').style.display = 'block';
  document.getElementById('charts-grid').style.display = 'none';
  document.getElementById('charts-placeholder').style.display = 'block';
  document.getElementById('downloads-list').style.display = 'none';
  document.getElementById('downloads-placeholder').style.display = 'block';
  document.getElementById('tab-report-badge').style.display = 'none';
  document.getElementById('tab-charts-badge').style.display = 'none';
  document.getElementById('tab-dl-badge').style.display = 'none';

  isRunning = true;
  setStatus('running');
  document.getElementById('btn-run').disabled = true;

  const payload = {
    analysis_request: document.getElementById('analysis-request').value.trim(),
    use_langgraph:    document.getElementById('use-langgraph').checked,
  };

  let res;
  try {
    res = await fetch('/api/analyze', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.detail || `HTTP ${res.status}`);
    }
  } catch (e) {
    toast(`Failed to start: ${e.message}`, 'error');
    appendLog({ type: 'error', message: `Failed to start analysis: ${e.message}` });
    isRunning = false;
    setStatus('error');
    document.getElementById('btn-run').disabled = false;
    return;
  }

  const { task_id } = await res.json();
  currentTaskId = task_id;
  toast('Analysis started', 'info');
  appendLog({ type: 'info', message: `Task ID: ${task_id}` });
  appendLog({ type: 'info', message: `LangGraph: ${payload.use_langgraph}` });
  appendLog({ type: 'info', message: 'â”€'.repeat(54) });

  connectSSE(task_id);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   SSE connection
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function connectSSE(taskId) {
  if (sseSource) { sseSource.close(); sseSource = null; }

  sseSource = new EventSource(`/api/stream/${taskId}`);

  sseSource.onmessage = (ev) => {
    let data;
    try { data = JSON.parse(ev.data); } catch { return; }

    if (data.type === 'complete') {
      onAnalysisComplete(taskId);
    } else if (data.type === 'error') {
      onAnalysisError(data.message || 'Unknown error');
    } else {
      appendLog(data);
    }
  };

  sseSource.onerror = () => {
    // SSE disconnected â€” poll for status
    sseSource.close();
    sseSource = null;
    if (isRunning) pollStatus(taskId);
  };
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Poll fallback (if SSE drops)
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function pollStatus(taskId) {
  const interval = setInterval(async () => {
    try {
      const r   = await fetch(`/api/status/${taskId}`);
      const st  = await r.json();
      if (st.status === 'completed') { clearInterval(interval); onAnalysisComplete(taskId); }
      if (st.status === 'error')     { clearInterval(interval); onAnalysisError(st.error); }
    } catch {}
  }, 3000);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   On complete
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function onAnalysisComplete(taskId) {
  if (sseSource) { sseSource.close(); sseSource = null; }
  isRunning = false;
  setStatus('completed');
  document.getElementById('btn-run').disabled = false;

  appendLog({ type: 'success', message: 'â•'.repeat(54) });
  appendLog({ type: 'success', message: '  âœ“  Analysis complete â€” loading resultsâ€¦' });
  appendLog({ type: 'success', message: 'â•'.repeat(54) });

  toast('Analysis complete! Switching to Report tab.', 'success');

  try {
    const res = await fetch(`/api/results/${taskId}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    renderReport(data.markdown_report || '');
    renderCharts(data.charts || []);
    renderDownloads(data.reports || []);

    // Auto-switch to Report
    document.querySelector('.tab-btn').click(); // console
    setTimeout(() => {
      document.querySelectorAll('.tab-btn')[1].click(); // report
    }, 400);

  } catch (e) {
    toast(`Could not load results: ${e.message}`, 'error');
  }
}

function onAnalysisError(msg) {
  if (sseSource) { sseSource.close(); sseSource = null; }
  isRunning = false;
  setStatus('error');
  document.getElementById('btn-run').disabled = false;
  appendLog({ type: 'error', message: `Analysis failed: ${msg}` });
  toast(`Analysis failed: ${msg}`, 'error');
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Render markdown report
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderReport(markdown) {
  const placeholder = document.getElementById('report-placeholder');
  const body        = document.getElementById('md-body');

  if (!markdown || markdown.trim().length < 10) {
    placeholder.style.display = 'block';
    body.style.display = 'none';
    return;
  }

  placeholder.style.display = 'none';
  body.style.display = 'block';
  body.innerHTML = marked.parse(markdown);

  // Apply highlight.js to code blocks
  body.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));

  // Show badge
  const badge = document.getElementById('tab-report-badge');
  badge.style.display = 'inline';
  setTimeout(() => badge.style.display = 'none', 5000);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Render charts gallery
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderCharts(charts) {
  const grid        = document.getElementById('charts-grid');
  const placeholder = document.getElementById('charts-placeholder');

  if (!charts || charts.length === 0) {
    placeholder.style.display = 'block';
    grid.style.display = 'none';
    return;
  }

  placeholder.style.display = 'none';
  grid.style.display = 'flex';
  grid.innerHTML = '';

  charts.forEach(chart => {
    const col = document.createElement('div');
    col.className = 'col-sm-6 col-md-4 col-xl-3';
    col.innerHTML = `
      <div class="chart-card" onclick="openLightbox('${chart.url}')">
        <img src="${chart.url}" alt="${chart.name}" loading="lazy" />
        <div class="chart-name">${chart.name}</div>
      </div>`;
    grid.appendChild(col);
  });

  // Update badge
  const badge = document.getElementById('tab-charts-badge');
  badge.textContent = charts.length;
  badge.style.display = 'inline';
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Render downloads
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderDownloads(reports) {
  const list        = document.getElementById('downloads-list');
  const placeholder = document.getElementById('downloads-placeholder');

  if (!reports || reports.length === 0) {
    placeholder.style.display = 'block';
    list.style.display = 'none';
    return;
  }

  placeholder.style.display = 'none';
  list.style.display = 'block';
  list.innerHTML = `<h6 class="mb-3" style="color:var(--text-muted)">
    <i class="fa fa-download me-1"></i>${reports.length} file(s) generated
  </h6>`;

  const iconMap = { pdf: 'ğŸ“„', pptx: 'ğŸ“Š', md: 'ğŸ“', png: 'ğŸ–¼ï¸' };
  const clsMap  = { pdf: 'icon-pdf', pptx: 'icon-pptx', md: 'icon-md', png: 'icon-png' };

  reports.forEach(r => {
    const sizeKB = (r.size / 1024).toFixed(1);
    const dt     = r.modified ? new Date(r.modified).toLocaleString() : '';
    const item   = document.createElement('div');
    item.className = 'file-item';
    item.innerHTML = `
      <div class="file-icon ${clsMap[r.ext] || ''}">${iconMap[r.ext] || 'ğŸ“'}</div>
      <div class="file-info">
        <div class="file-name">${r.name}</div>
        <div class="file-meta">${sizeKB} KB &nbsp;Â·&nbsp; ${dt}</div>
      </div>
      <a href="${r.url}" download class="btn btn-sm ms-auto"
         style="background:var(--badge-bg);border:1px solid var(--border);color:var(--text);font-size:.8rem">
        <i class="fa fa-download me-1"></i>Download
      </a>`;
    list.appendChild(item);
  });

  // Badge
  const badge = document.getElementById('tab-dl-badge');
  badge.textContent = reports.length;
  badge.style.display = 'inline';
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Refresh helpers (called when switching to tabs after completion)
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function refreshCharts() {
  if (!currentTaskId) return;
  const r = await fetch('/api/charts').catch(() => null);
  if (!r || !r.ok) return;
  const { charts } = await r.json();
  renderCharts(charts);
}

async function refreshDownloads() {
  if (!currentTaskId) return;
  const r = await fetch('/api/reports').catch(() => null);
  if (!r || !r.ok) return;
  const { reports } = await r.json();
  renderDownloads(reports);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Lightbox
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function openLightbox(src) {
  document.getElementById('lightbox-img').src = src;
  document.getElementById('lightbox').classList.add('open');
}

function closeLightbox() {
  document.getElementById('lightbox').classList.remove('open');
}

document.getElementById('lightbox').addEventListener('click', (e) => {
  if (e.target === document.getElementById('lightbox')) closeLightbox();
});

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeLightbox();
});

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Console auto-scroll toggle (click to pause)
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
consoleEl.addEventListener('scroll', () => {
  const threshold = 40;
  const atBottom  = consoleEl.scrollHeight - consoleEl.scrollTop - consoleEl.clientHeight < threshold;
  autoScrollConsole = atBottom;
});
</script>
</body>
</html>
